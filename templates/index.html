<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskly - Kanban Board</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script type="text/javascript">
        !function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
        src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js",
        cfg: {
            connectionString: "InstrumentationKey=52267e47-f640-4930-a132-c597e28d10bd;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/;LiveEndpoint=https://westeurope.livediagnostics.monitor.azure.com/;ApplicationId=11b1f02d-3449-4276-a7c8-16dcc1e5efdf"
        }});
    </script>
</head>
<body>
    <div class="app-shell">
        <nav class="top-nav">
            <div class="nav-inner">
                <div class="brand">
                    <div class="brand-mark">Taskly</div>
                    <p class="brand-sub">Flow your tasks across the board</p>
                </div>
                <div class="nav-right">
                    <div class="notif-wrapper">
                        <button class="icon-button" id="notificationsBtn" aria-label="Notifications">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path fill="currentColor" d="M12 22a2 2 0 0 0 1.995-1.85L14 20h-4a2 2 0 0 0 1.85 1.995L12 22Zm8-6v-5a8 8 0 1 0-16 0v5l-2 2v1h20v-1l-2-2Zm-2 0 1.293 1.293.207.207H5.5l.207-.207L7 16v-5a5 5 0 1 1 10 0v5Z"/>
                            </svg>
                        </button>
                        <div class="notif-dropdown" id="notificationsDropdown" style="display:none;">
                            <div class="notif-header">Notifications</div>
                            <div class="notif-list" id="notifList">
                                <div class="notif-empty">No due items right now.</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-menu">
                        <button class="user-button" id="userDropdownBtn">
                            <span class="user-avatar">{{ session.get('username', 'U')[0].upper() }}</span>
                            <div class="user-info">
                                <span class="user-name">{{ session.get('username', 'User') }}</span>
                                <span class="user-email">{{ session.get('email', 'No email') }}</span>
                            </div>
                            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M4 6l4 4 4-4"/>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown" style="display: none;">
                            <div class="dropdown-header">
                                <div class="dropdown-avatar">{{ session.get('username', 'U')[0].upper() }}</div>
                                <div>
                                    <div class="dropdown-username">{{ session.get('username', 'User') }}</div>
                                    <div class="dropdown-email">{{ session.get('email', 'No email') }}</div>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="openChangeUsernameModal(); return false;" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                </svg>
                                Change Username
                            </a>
                            <a href="#" onclick="openChangePasswordModal(); return false;" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                                </svg>
                                Change Password
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="openSettingsModal(); return false;" class="dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                                </svg>
                                Settings
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="{{ url_for('logout') }}" class="dropdown-item dropdown-item-danger">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                </svg>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-banner-container flash-banner-center" id="flashBanner">
                {% for category, message in messages %}
                <div class="flash-banner {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <main class="page-content">
            <section class="filter-bar inline-controls">
                <div class="filter-control">
                    <label for="searchInput">Search</label>
                    <div class="input-wrap">
                        <input type="search" id="searchInput" placeholder="Find by title or description">
                    </div>
                </div>
                <div class="filter-control">
                    <label for="priorityFilter">Priority</label>
                    <div class="input-wrap">
                        <select id="priorityFilter">
                            <option value="All" selected>All priorities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="filter-control">
                    <label for="categoryFilter">Category</label>
                    <div class="input-wrap">
                        <select id="categoryFilter">
                            <option value="All" selected>All categories</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Food & Dining">Food & Dining</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Health & Fitness">Health & Fitness</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Finance">Finance</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Technology">Technology</option>
                            <option value="Family">Family</option>
                            <option value="Sports">Sports</option>
                            <option value="Hobbies">Hobbies</option>
                            <option value="Pets">Pets</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="secondary" type="button" onclick="filterTasks()">Apply</button>
                    <button class="ghost" type="button" onclick="resetFilters()">Reset</button>
                    <button class="primary" type="button" onclick="openAddModal()">+ New Task</button>
                </div>
            </section>

            <section class="stats-grid">
                <div class="stat-card stat-overdue">
                    <div class="stat-label">Overdue</div>
                    <div class="stat-value">{{ stats.overdue }}</div>
                </div>
                <div class="stat-card stat-today">
                    <div class="stat-label">Due Today</div>
                    <div class="stat-value">{{ stats.due_today }}</div>
                </div>
                <div class="stat-card stat-week">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value">{{ stats.due_week }}</div>
                </div>
                <div class="stat-card stat-total">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value">{{ stats.total }}</div>
                </div>
            </section>

            {% if tasks %}
            <section class="kanban-board">
                <div class="kanban-column column-todo">
                    <div class="column-header">
                        <h3 class="column-title">To do</h3>
                        <span class="column-count" id="count-todo">0</span>
                    </div>
                    <div class="column-body" id="column-todo">
                        {% for task in tasks %}
                        {% if task.status == 'todo' %}
                        {% include 'task_card.html' %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="kanban-column column-progress">
                    <div class="column-header">
                        <h3 class="column-title">In progress</h3>
                        <span class="column-count" id="count-in_progress">0</span>
                    </div>
                    <div class="column-body" id="column-in_progress">
                        {% for task in tasks %}
                        {% if task.status == 'in_progress' %}
                        {% include 'task_card.html' %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="kanban-column column-review">
                    <div class="column-header">
                        <h3 class="column-title">In review</h3>
                        <span class="column-count" id="count-in_review">0</span>
                    </div>
                    <div class="column-body" id="column-in_review">
                        {% for task in tasks %}
                        {% if task.status == 'in_review' %}
                        {% include 'task_card.html' %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="kanban-column column-done">
                    <div class="column-header">
                        <h3 class="column-title">Done</h3>
                        <span class="column-count" id="count-done">0</span>
                    </div>
                    <div class="column-body" id="column-done">
                        {% for task in tasks %}
                        {% if task.status == 'done' %}
                        {% include 'task_card.html' %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% else %}
            <div class="empty-state">
                <div class="empty-card">
                    <p>No tasks yet</p>
                    <button class="primary" type="button" onclick="openAddModal()">Create your first task</button>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <div class="modal" id="taskModal" data-add-url="{{ url_for('add_task') }}" data-edit-url-template="{{ url_for('edit_task', task_id=0) }}">
        <div class="modal-panel">
            <div class="modal-header">
                <div>
                    <p class="eyebrow">Task</p>
                    <h3 id="taskModalTitle">Add task</h3>
                </div>
                <button class="close-modal" type="button" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm" method="POST" action="{{ url_for('add_task') }}" class="modal-body">
                <div class="form-grid">
                    <label>
                        <span>Title</span>
                        <input type="text" name="title" required maxlength="255" placeholder="Short, clear task title">
                    </label>
                    <label>
                        <span>Description</span>
                        <textarea name="description" rows="3" placeholder="What needs to happen?"></textarea>
                    </label>
                    <label>
                        <span>Priority</span>
                        <select name="priority">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </label>
                    <label>
                        <span>Category</span>
                        <select name="category">
                            <option value="Shopping">Shopping</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Food & Dining">Food & Dining</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Health & Fitness">Health & Fitness</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Finance">Finance</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Technology">Technology</option>
                            <option value="Family">Family</option>
                            <option value="Sports">Sports</option>
                            <option value="Hobbies">Hobbies</option>
                            <option value="Pets">Pets</option>
                            <option value="Other">Other</option>
                        </select>
                    </label>
                    <label>
                        <span>Status</span>
                        <select name="status">
                            <option value="todo">To do</option>
                            <option value="in_progress">In progress</option>
                            <option value="in_review">In review</option>
                            <option value="done">Done</option>
                        </select>
                    </label>
                    <label>
                        <span>Due date</span>
                        <input type="datetime-local" name="due_date">
                    </label>
                </div>
                <div class="modal-actions">
                    <button class="ghost" type="button" onclick="closeTaskModal()">Cancel</button>
                    <button class="primary" type="submit">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="changeUsernameModal" class="modal" style="display: none;">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Change Username</h2>
                <span class="close-modal" onclick="closeChangeUsernameModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changeUsernameForm" onsubmit="changeUsername(event)">
                    <div class="form-group">
                        <label for="newUsername">New Username</label>
                        <input type="text" id="newUsername" name="newUsername" required minlength="3" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="currentPasswordUsername">Current Password (for verification)</label>
                        <input type="password" id="currentPasswordUsername" name="currentPassword" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="ghost" onclick="closeChangeUsernameModal()">Cancel</button>
                        <button type="submit" class="primary">Change Username</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal" style="display: none;">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Change Password</h2>
                <span class="close-modal" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="ghost" onclick="closeChangePasswordModal()">Cancel</button>
                        <button type="submit" class="primary">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-panel">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Theme</h3>
                    <div class="form-group">
                        <label for="themeSelect">App Theme</label>
                        <select id="themeSelect" onchange="applyTheme(this.value)">
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Notifications</h3>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="browserNotifications" onchange="toggleBrowserNotifications(this.checked)">
                            <span>Browser Notifications</span>
                        </label>
                        <small>Get notified about overdue and due today tasks</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const flashBanner = document.getElementById('flashBanner');
        if (flashBanner) {
            setTimeout(() => {
                flashBanner.style.opacity = '0';
                setTimeout(() => flashBanner.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
